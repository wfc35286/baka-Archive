name: Build & Release | ç¼–è¯‘ä¸å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Select Build Type | é€‰æ‹©æ„å»ºç±»å‹'
        required: true
        default: 'release and debug'
        type: choice
        options:
          - debug
          - release
          - release and debug

permissions:
  contents: write

jobs:
  build:
    name: Build APK | ç¼–è¯‘ APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code | æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Build Gate | æ£€æŸ¥ç¼–è¯‘å¼€å…³
        id: check_gate
        run: |
          if [ -f "build_config.ini" ]; then
              IS_ENABLE=$(grep ENABLE_BUILD build_config.ini | cut -d'=' -f2 | xargs | tr '[:upper:]' '[:lower:]')
          else
              IS_ENABLE="true"
          fi
          echo "GATE=$IS_ENABLE" >> $GITHUB_OUTPUT

      - name: Set up JDK 21 | è®¾ç½® JDK 21
        if: steps.check_gate.outputs.GATE == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Extract Changelog | æå–æ›´æ–°æ—¥å¿—
        if: steps.check_gate.outputs.GATE == 'true'
        run: |
          PREV_TAG=$(git describe --tags --match "Release-*" --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            LOGS=$(git log --date=format:"%m-%d %H:%M" --pretty=format:"[%ad] %s" -n 15 | grep -vE "chore:|Merge")
          else
            LOGS=$(git log ${PREV_TAG}..HEAD --date=format:"%m-%d %H:%M" --pretty=format:"[%ad] %s" | grep -vE "chore:|Merge")
          fi
          [ -z "$LOGS" ] && LOGS="æ€§èƒ½ä¼˜åŒ–ä¸ç¨³å®šæ€§æå‡"
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$LOGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Grant execute permission for gradlew | èµ‹äºˆ gradlew æ‰§è¡Œæƒé™
        if: steps.check_gate.outputs.GATE == 'true'
        run: chmod +x gradlew

      - name: Build with Gradle | ä½¿ç”¨ Gradle ç¼–è¯‘
        if: steps.check_gate.outputs.GATE == 'true'
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          if [ -z "$BUILD_TYPE" ]; then BUILD_TYPE="release and debug"; fi
          
          if [ "$BUILD_TYPE" == "release" ]; then
            ./gradlew assembleRelease
          elif [ "$BUILD_TYPE" == "debug" ]; then
            ./gradlew assembleDebug
          else
            ./gradlew assembleRelease assembleDebug
          fi

      - name: Collect Build Data | æ”¶é›†æ„å»ºæ•°æ®
        if: steps.check_gate.outputs.GATE == 'true'
        id: collect_data
        run: |
          # ä¿®å¤ç‰ˆæœ¬å·æå–é€»è¾‘ï¼šä½¿ç”¨ cut åˆ†å‰²å†’å·ï¼Œç²¾å‡†è·å–å€¼
          V_NAME=$(./gradlew -q :app:showVersion | grep 'FINAL_VERSION_NAME' | cut -d':' -f2 | xargs)
          V_CODE=$(./gradlew -q :app:showVersion | grep 'FINAL_VERSION_CODE' | cut -d':' -f2 | xargs)
          [ -z "$V_NAME" ] && V_NAME="1.0.0.$(date +'%Y%m%d')"
          
          REL_APK="app/build/outputs/apk/release/app-release.apk"
          DBG_APK="app/build/outputs/apk/debug/app-debug.apk"
          V_TAG="Release-$V_NAME"
          
          echo "V_NAME=$V_NAME" >> $GITHUB_ENV
          echo "V_TAG=$V_TAG" >> $GITHUB_ENV
          
          FILES=""
          if [ -f "$REL_APK" ]; then
            REL_SHA=$(sha256sum $REL_APK | cut -d' ' -f1)
            echo "REL_SHA=$REL_SHA" >> $GITHUB_ENV
            cp $REL_APK baka_v${V_NAME}_release.apk
            FILES="baka_v${V_NAME}_release.apk"
          fi
          if [ -f "$DBG_APK" ]; then
            DBG_SHA=$(sha256sum $DBG_APK | cut -d' ' -f1)
            echo "DBG_SHA=$DBG_SHA" >> $GITHUB_ENV
            cp $DBG_APK baka_v${V_NAME}_debug.apk
            if [ -z "$FILES" ]; then FILES="baka_v${V_NAME}_debug.apk"; else FILES="$FILES,baka_v${V_NAME}_debug.apk"; fi
          fi
          echo "FILES=$FILES" >> $GITHUB_ENV

      - name: Sync Version to Repo | åŒæ­¥ç‰ˆæœ¬å·åˆ°ä»“åº“
        if: steps.check_gate.outputs.GATE == 'true' && github.event_name != 'pull_request'
        run: |
          git config --global user.name "Manus-Bot"
          git config --global user.email "manus@ai.com"
          git add version.properties app/version.properties || true
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·è‡³ ${{ env.V_NAME }} [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
          fi

      - name: Release to baka-update (Release Only) | å‘å¸ƒè‡³ baka-update (ä»… Release)
        if: steps.check_gate.outputs.GATE == 'true' && env.REL_SHA != ''
        uses: softprops/action-gh-release@v2
        with:
          repository: wfc35286/baka-update 
          tag_name: ${{ env.V_NAME }}
          name: "${{ env.V_TAG }}"
          body: |
            ## ğŸš€ New Update | æ–°ç‰ˆæœ¬å‘å¸ƒ
            ğŸ“¦ **Changelog | æ›´æ–°å†…å®¹**
            ${{ env.CHANGELOG }}
            ---
            **Checksum | æ ¡éªŒç  (SHA-256):** `${{ env.REL_SHA }}`
          files: baka_v${{ env.V_NAME }}_release.apk
          token: ${{ secrets.MY_BAKA_TOKEN || secrets.GITHUB_TOKEN }}
          allow_updates: true
          make_latest: true

      - name: Release to Archive Repo | å‘å¸ƒè‡³å½’æ¡£ä»“åº“ (Release + Debug)
        if: steps.check_gate.outputs.GATE == 'true' && env.FILES != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.V_TAG }}
          name: "${{ env.V_TAG }} (CI Build)"
          body: |
            ## ğŸ” Build Archive | æ„å»ºå½’æ¡£
            - **Release SHA256**: `${{ env.REL_SHA }}`
            - **Debug SHA256**: `${{ env.DBG_SHA }}`
            
            ğŸ“¦ **Changelog | æ›´æ–°å†…å®¹**
            ${{ env.CHANGELOG }}
            
            *Debug version contains symbols for debugging.*
            *Debug ç‰ˆæœ¬åŒ…å«è°ƒè¯•ç¬¦å·ï¼Œä»…ä¾›æ’æŸ¥é—®é¢˜ä½¿ç”¨ã€‚*
          files: |
            baka_v${{ env.V_NAME }}_release.apk
            baka_v${{ env.V_NAME }}_debug.apk
          token: ${{ secrets.GITHUB_TOKEN }}
          allow_updates: true
