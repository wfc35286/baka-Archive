name: Build & Release

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'é€‰æ‹©æ„å»ºç±»å‹ (debug æˆ– release)'
        required: true
        default: 'release'
        type: choice
        options:
          - debug
          - release

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: |
          if [ "${{ github.event.inputs.build_type }}" == "release" ]; then
            ./gradlew assembleRelease
          else
            ./gradlew assembleDebug
          fi

      - name: Get Version Info
        id: get_version
        run: |
          VERSION_NAME=$(./gradlew :app:showVersion -q | grep "FINAL_VERSION_NAME" | cut -d':' -f2)
          VERSION_CODE=$(./gradlew :app:showVersion -q | grep "FINAL_VERSION_CODE" | cut -d':' -f2)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Prepare APK for Upload
        run: |
          mkdir -p release_artifacts
          if [ "${{ github.event.inputs.build_type }}" == "release" ]; then
            cp app/build/outputs/apk/release/*.apk release_artifacts/baka_v${{ steps.get_version.outputs.VERSION_NAME }}_release.apk
          else
            cp app/build/outputs/apk/debug/*.apk release_artifacts/baka_v${{ steps.get_version.outputs.VERSION_NAME }}_debug.apk
          fi

      - name: Create Release and Upload Asset
        if: github.event.inputs.build_type == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION_NAME }}
          name: Release v${{ steps.get_version.outputs.VERSION_NAME }} (${{ steps.get_version.outputs.VERSION_CODE }})
          body: |
            ## ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ
            - **ç‰ˆæœ¬åç§°**: ${{ steps.get_version.outputs.VERSION_NAME }}
            - **ç‰ˆæœ¬ä»£ç **: ${{ steps.get_version.outputs.VERSION_CODE }}
            - **æ„å»ºæ—¶é—´**: ${{ steps.get_version.outputs.BUILD_TIME }}
            - **æ„å»ºç±»å‹**: ${{ github.event.inputs.build_type }}
            
            > æœ¬æ¬¡å‘å¸ƒç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆã€‚
          files: release_artifacts/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Debug)
        if: github.event.inputs.build_type == 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: baka-debug-apk
          path: release_artifacts/*.apk
