name: Android CI/CD Perfect

on:
  push:
    branches: [ "main", "master" ]
  # â­ æ´›çªå¸Œï¼šåªåŠ äº†è¿™ä¸€è¡Œï¼è¿™å°±ç›¸å½“äºç»™è‡ªåŠ¨é—¨è£…äº†ä¸ªé—¨æŠŠæ‰‹ï¼ŒåŸæ¥çš„è‡ªåŠ¨æ„Ÿåº”è¿˜åœ¨ã€‚
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºæºç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: æ£€æŸ¥ç¼–è¯‘å¼€å…³
      id: check_gate
      run: |
        if [ -f "build_config.ini" ]; then
            IS_ENABLE=$(grep ENABLE_BUILD build_config.ini | cut -d'=' -f2 | xargs | tr '[:upper:]' '[:lower:]')
        else
            IS_ENABLE="true"
        fi
        echo "GATE=$IS_ENABLE" >> $GITHUB_OUTPUT

    - name: è®¾ç½® Java ç¯å¢ƒ
      if: steps.check_gate.outputs.GATE == 'true'
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: æå–æ›´æ–°æ—¥å¿—
      if: steps.check_gate.outputs.GATE == 'true'
      run: |
        PREV_TAG=$(git describe --tags --match "Release-*" --abbrev=0 2>/dev/null || echo "")
        if [ -z "$PREV_TAG" ]; then
          LOGS=$(git log --date=format:"%m-%d %H:%M" --pretty=format:"[%ad] %s" -n 15 | grep -vE "chore:|Merge")
        else
          LOGS=$(git log ${PREV_TAG}..HEAD --date=format:"%m-%d %H:%M" --pretty=format:"[%ad] %s" | grep -vE "chore:|Merge")
        fi
        [ -z "$LOGS" ] && LOGS="æ€§èƒ½ä¼˜åŒ–ä¸ç¨³å®šæ€§æå‡"
        echo "CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$LOGS" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: æ‰§è¡ŒåŒé‡ç¼–è¯‘ (Release & Debug)
      if: steps.check_gate.outputs.GATE == 'true'
      run: |
        chmod +x gradlew
        git update-index --chmod=+x gradlew || true
        # â­ æ´›çªå¸Œï¼šè¿™é‡Œæ”¹æˆäº†åªç¼–è¯‘ Release å’Œ Debugï¼Œä¸å†åŒºåˆ† Flavor
        ./gradlew :app:assembleRelease :app:assembleDebug

    - name: æ”¶é›†å‘å¸ƒæ•°æ®
      if: steps.check_gate.outputs.GATE == 'true'
      id: collect_data
      run: |
        V_NAME=$(./gradlew -q :app:showVersion | grep 'FINAL_VERSION' | sed 's/FINAL_VERSION://' | xargs)
        [ -z "$V_NAME" ] && V_NAME="1.0.0.$(date +'%Y%m%d')"
        
        # â­ æ´›çªå¸Œï¼šè·¯å¾„ä¿®æ­£ï¼Œç§»é™¤äº† flavor ç›®å½•ï¼Œå¢åŠ äº† Debug è·¯å¾„
        REL_APK="app/build/outputs/apk/release/app-release.apk"
        DBG_APK="app/build/outputs/apk/debug/app-debug.apk"
        V_TAG="Release-$V_NAME"
        
        echo "V_NAME=$V_NAME" >> $GITHUB_ENV
        echo "V_TAG=$V_TAG" >> $GITHUB_ENV
        echo "REL_APK=$REL_APK" >> $GITHUB_ENV
        echo "DBG_APK=$DBG_APK" >> $GITHUB_ENV
        
        # è®¡ç®—æ ¡éªŒç  (Debug åŒ…å¦‚æœä¸å­˜åœ¨åˆ™ä¸è®¡ç®—ï¼Œé˜²æ­¢æŠ¥é”™ï¼Œè™½ç„¶æ­£å¸¸éƒ½ä¼šæœ‰)
        if [ -f "$REL_APK" ]; then
          echo "REL_SHA=$(sha256sum $REL_APK | cut -d' ' -f1)" >> $GITHUB_ENV
        fi
        if [ -f "$DBG_APK" ]; then
          echo "DBG_SHA=$(sha256sum $DBG_APK | cut -d' ' -f1)" >> $GITHUB_ENV
        fi

    # â­ æ ¸å¿ƒä¿®æ­£ï¼šå¿…é¡»åœ¨ Release ä¹‹å‰åŒæ­¥ç‰ˆæœ¬å·
    - name: åŒæ­¥ç‰ˆæœ¬å·åˆ°ä»“åº“
      if: steps.check_gate.outputs.GATE == 'true'
      run: |
        git config --global user.name "Roxy-Bot"
        git config --global user.email "roxy@migurdia.com"
        git update-index --assume-unchanged gradlew || true
        git add version.properties app/version.properties || true
        
        if [ -n "$(git status --porcelain)" ]; then
          echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬å˜æ›´ï¼ŒåŒæ­¥å›ä»“åº“..."
          git commit -m "chore: è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·è‡³ ${{ env.V_NAME }} [skip ci]"
          git push origin HEAD:${{ github.ref_name }}
        fi

    - name: å‘å¸ƒè‡³ baka-update (ä»… Release)
      if: steps.check_gate.outputs.GATE == 'true'
      uses: softprops/action-gh-release@v2
      with:
        repository: wfc35286/baka-update 
        tag_name: ${{ env.V_NAME }}
        name: "${{ env.V_TAG }}"
        body: |
          ğŸ“¦ **æ›´æ–°å†…å®¹**
          ${{ env.CHANGELOG }}
          ---
          æ ¡éªŒç  (SHA-256): `${{ env.REL_SHA }}`
        # â­ æ´›çªå¸Œï¼šè¿™é‡Œåªä¸Šä¼  Release åŒ…
        files: ${{ env.REL_APK }}
        token: ${{ secrets.MY_BAKA_TOKEN }}
        allow_updates: true
        make_latest: true

    - name: å‘å¸ƒè‡³æœ¬ä»“åº“ (Release + Debug å½’æ¡£)
      if: steps.check_gate.outputs.GATE == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.V_TAG }}
        name: "${{ env.V_TAG }} (CI Build)"
        body: |
          ğŸ” **æ„å»ºå½’æ¡£**
          - **Release**: `${{ env.REL_SHA }}`
          - **Debug**: `${{ env.DBG_SHA }}`
          
          *Debug ç‰ˆæœ¬åŒ…å«è°ƒè¯•ç¬¦å·ï¼Œä»…ä¾›å¼€å‘è€…æ’æŸ¥é—®é¢˜ä½¿ç”¨ã€‚*
        # â­ æ´›çªå¸Œï¼šè¿™é‡ŒåŒæ—¶ä¸Šä¼  Release å’Œ Debug åŒ…
        files: |
          ${{ env.REL_APK }}
          ${{ env.DBG_APK }}
        token: ${{ secrets.GITHUB_TOKEN }}
        allow_updates: true
